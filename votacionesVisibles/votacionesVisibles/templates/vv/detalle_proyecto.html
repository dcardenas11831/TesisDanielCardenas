{% extends "vv/base.html" %}

{% block imports%}
{% load staticfiles %}
<link rel="stylesheet" href="http://code.jquery.com/ui/1.8.2/themes/base/jquery-ui.css" type="text/css" media="all" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.min.js"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/highcharts-more.js"></script>
<meta charset="utf-8">

{% endblock %}
{% block title %}Proyecto de ley - Votaciones Visibles{% endblock %}

{% block content %}
    <h1 id="tema_seleccionado">PROYECTO DE LEY</h1>
    <h2 id="proyecto_seleccionado"> {{proyecto.titulo}}</h2>

    <div id="columna_izquierda">
        <p>    <mark>TEMA PRINCIPAL:</mark> {{proyecto.tema_principal.nombre}}</p>
        <p>    <mark>RESUMEN:</mark> {{proyecto.sinapsis}}</p>
        <p>    <mark>ESTADO ACTUAL:</mark> {{proyecto.estado_proyecto_ley_actual.estado.nombre}}</p>
        <p>    <mark>PALABRAS CLAVE:</mark> {{proyecto.tags}}</p>
        <p>    <mark>INICIATIVA:</mark> {{proyecto.iniciativa.nombre}}</p>
        <p>    <mark>TIPO PROYECTO:</mark> {{proyecto.tipo_proyecto.nombre}}</p>
        <p>    <mark>FECHA RADICACION:</mark> {{proyecto.fecha_radicacion}}</p>
        <p>    <mark>VOTACIONES:</mark> </p>
        <div id="tabs" class="tabrow">
            <ul>
                {% for estado in estados %}
                <li><a href="#{{estado.id}}"> {{estado.estado.nombre}}</a></li>
                {% endfor %}
            </ul>
            <div id="info"></div>
            <div id="chart_panel"></div>
        </div>
    </div>

    <div id="columna_derecha">
        <p>Digite el nombre del congresista o partido de su inter&#233;s para ver sus votos en este proyecto</p>
        <div class="ui-widget">
            <form id="votos" method="GET">
                <input id="busqueda" name="busqueda">
                <input type="hidden" name="ids_estados" value={{ids_estados}}>
                <input type="hidden" name="ids_votaciones" value={{ids_votaciones}}>
                <input type="submit" class="btn-buscar" value="">
            </form>
        </div>
        <div id="tabla" class="tabla"></div>
        <ul>
            {% for estado in estados %}
            <li> {{estado.estado.nombre}} {{estado.fecha}} {{estado.id}}</li>
            {% endfor %}
        </ul>
    </div>


    <script type="text/javascript" charset="UTF-8">
			$(function () {

	var partidos = {{ partidos|safe }};

	fijox = 7;
	fijoy = 1.5;
	votos = [];
	tooltip_votos = {};
    for(partido of partidos){
    	votos = partido.data;
    	tooltip_votos[partido.name] = partido.total_votos;
    	temps = [];
    	if (votos.inasistencias > 0){
            ina = {name: "Inasistencias", x: fijox, y: fijoy+3*0, z: 100*votos.inasistencias/partido.total_votos};
            temps.push(ina);
    	}
    	if (votos.abstenciones > 0){
            abs = {name: "Abstenciones", x: fijox, y: fijoy+3*1, z: 100*votos.abstenciones/partido.total_votos};
            temps.push(abs);
    	}
    	if (votos.no > 0){
            no = {name: "No", x: fijox, y: fijoy+3*2, z: 100*votos.no/partido.total_votos};
            temps.push(no);
    	}
    	if (votos.si > 0){
            si = {name: "Si", x: fijox, y: fijoy+3*3, z: 100*votos.si/partido.total_votos};
            temps.push(si);
    	}
    	//for (v = 0; v < 4; v++) {
    	//	if(votos[v] > 0){
    	//		temp = [fijox, fijoy+3*v, votos[v]/votos.total_votos];
    	//		temps.push(temp);
    	//	}
    	//}
    	partido.data = temps;
    	fijox += 2;
    }
    console.log(partidos);
    console.log(tooltip_votos);
    partidos.push(
    	{
        	enableMouseTracking: false,
        	color: 'transparent',
        	showInLegend: false,
            data: [[3, 1.5, 0]]
        },{
        	enableMouseTracking: false,
        	color: 'transparent',
        	showInLegend: false,
            data: [[5, 1.5, 0]]
        });

    $('#chart_panel').highcharts({

        chart: {
            type: 'bubble',
            zoomType: 'none',
            style: {
                    //fontFamily: 'sans-serif',
            },
        },

        title: {
            text: ''
        },
        tooltip: {
    		formatter: function() {
    		    temp = +this.point.z.toFixed(2)
        		return '<b>'+this.series.name + ': </b><br>'+
        		this.point.name+": "+temp+"% <br>"+
        		Math.round(0.01*tooltip_votos[this.series.name]*this.point.z)+
        		" de "+tooltip_votos[this.series.name]+" congresistas";
    		}
		},
        plotOptions: {
            bubble: {
                marker: {
                    lineWidth: 0,
                },
                //tooltip: {
                //    headerFormat: '<b>{series.name}</b><br>',
                //    pointFormat: '{point.name}: {point.z}%<br> {series.name}'

                //},
            },
        },
        xAxis: {
            lineWidth: 0,
            minorGridLineWidth: 0,
            lineColor: 'transparent',
            labels: {
                enabled: false
            },
            minorTickLength: 0,
            tickLength: 0,
        },

        yAxis: {
            gridLineWidth: 0,
            lineWidth: 0,
            minorGridLineWidth: 0,
            lineColor: 'transparent',
            labels: {
                enabled: false
            },
            title: {
                text: ''
            },
            minorTickLength: 0,
            tickLength: 1,
            plotLines: [
            {
                color: 'grey', // Color value
                value: 0,
                width: 2, // Width of the line
                label: {
                    text: 'Inasistencias',
                    align: 'left',
                    y: -20,
                    style: {
                        color: 'grey',
                        fontWeight: 'bold',
                    },
                },
            },
            {
                color: 'grey', // Color value
                value: 3,
                width: 2, // Width of the line
                label: {
                    text: 'Abstenciones',
                    align: 'left',
                    y: -20,
                    style: {
                        color: 'grey',
                        fontWeight: 'bold',
                    },
                },
            },
            {
                color: 'grey', // Color value
                value: 6,
                width: 2, // Width of the line
                label: {
                    text: 'No',
                    align: 'left',
                    y: -20,
                    style: {
                        color: 'grey',
                        fontWeight: 'bold',
                    },
                },
            },
            {
                color: 'grey', // Color value
                value: 9,
                width: 2, // Width of the line
                label: {
                    text: 'Si',
                    align: 'left',
                    y: -20,
                    style: {
                        color: 'grey',
                        fontWeight: 'bold',
                    },
                },
            }],
        },

        series: partidos,
    });
});
	</script>
    <script type="text/javascript" charset="UTF-8">
        $(function() {
            $("#busqueda").autocomplete({
                source: "/busqueda/autocompletar/",
                minLength: 2,
            });
        });
    </script>
    <script type="text/javascript" charset="UTF-8">
        $(document).ready(function() {

            $("#votos").submit(function() { // catch the form's submit event
                $.ajax({ // create an AJAX call...
                    data: $(this).serialize(), // get the form data
                    //data: $("#busqueda").prop('value'),
                    type: $(this).attr('GET'),
                    url: '/busqueda/ver_votos/',
                    success: function(response) { // on success..
                        $("#tabla").html(response); // update the DIV
                    }
                });
                return false;
            });
        });
    </script>
    <script type="text/javascript" charset="UTF-8">
        $("#tabs").tabs({
            activate: function (event, ui) {
                var active = $('#tabs').tabs('option', 'active');
                $("#info").html('the tab id is ' + $("#tabs ul>li a").eq(active).attr("href"));
                }
        });
    </script>
{% endblock %}